{% extends 'admin_ui/base.html' %}
{% load static %}

{% block title %}Dynamic ESP32 Session Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        🚀 Dynamic ESP32 Session Management
                    </h3>
                    <p class="text-muted">Create real-time ESP32 sessions with dynamic configuration</p>
                </div>
                <div class="card-body">
                    
                    <!-- ESP32 Device Status -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="info-box bg-info">
                                <span class="info-box-icon"><i class="fas fa-wifi"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total Devices</span>
                                    <span class="info-box-number">{{ total_devices }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-success">
                                <span class="info-box-icon"><i class="fas fa-check-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Online Devices</span>
                                    <span class="info-box-number">{{ online_devices }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-warning">
                                <span class="info-box-icon"><i class="fas fa-exclamation-triangle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Offline Devices</span>
                                    <span class="info-box-number">{{ offline_devices }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-primary">
                                <span class="info-box-icon"><i class="fas fa-play-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Available for Session</span>
                                    <span class="info-box-number">{{ available_devices|length }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Available Devices List -->
                    {% if available_devices %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">📱 Available ESP32 Devices</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Device Name</th>
                                                    <th>SSID</th>
                                                    <th>Location</th>
                                                    <th>Last Seen</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for device in available_devices %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ device.device_name|default:"Unnamed Device" }}</strong>
                                                    </td>
                                                    <td>
                                                        <code>{{ device.ssid|default:"Not Set" }}</code>
                                                    </td>
                                                    <td>{{ device.location|default:"Not Set" }}</td>
                                                    <td>
                                                        {% if device.last_heartbeat %}
                                                            <span class="badge badge-success">
                                                                {{ device.last_heartbeat|timesince }} ago
                                                            </span>
                                                        {% else %}
                                                            <span class="badge badge-warning">Never</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-success">🟢 Online</span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Create Session Form -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">🎯 Create New ESP32 Session</h5>
                                </div>
                                <div class="card-body">
                                    {% if available_devices %}
                                        <form method="post">
                                            {% csrf_token %}
                                            
                                            <div class="form-group">
                                                <label for="course">Select Course</label>
                                                <select name="course" id="course" class="form-control" required>
                                                    <option value="">Choose a course...</option>
                                                    {% for assigned in assigned_courses %}
                                                        <option value="{{ assigned.course.id }}">
                                                            {{ assigned.course.code }} - {{ assigned.course.title }}
                                                            ({{ assigned.session }}, {{ assigned.semester }})
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="session">Academic Session</label>
                                                        <input type="text" name="session" id="session" class="form-control" 
                                                               value="2024/2025" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="semester">Semester</label>
                                                        <select name="semester" id="semester" class="form-control" required>
                                                            <option value="1st Semester">1st Semester</option>
                                                            <option value="2nd Semester">2nd Semester</option>
                                                            <option value="Summer">Summer</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="start_time">Start Time</label>
                                                        <input type="time" name="start_time" id="start_time" 
                                                               class="form-control" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Dynamic Configuration:</strong> The ESP32 will automatically:
                                                <ul class="mb-0 mt-2">
                                                    <li>Generate a unique WiFi name (e.g., "Attendance_CS101_John_14:30")</li>
                                                    <li>Set device ID and location based on course and lecturer</li>
                                                    <li>Create a captive portal for students to mark attendance</li>
                                                </ul>
                                            </div>

                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-play"></i> Start ESP32 Session
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>No Available ESP32 Devices</strong><br>
                                            All ESP32 devices are currently offline or in use. Please:
                                            <ul class="mb-0 mt-2">
                                                <li>Check if ESP32 devices are powered on</li>
                                                <li>Verify internet connectivity</li>
                                                <li>Wait for devices to come online</li>
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">📋 Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <a href="{% url 'admin_ui:esp32_device_list' %}" class="btn btn-outline-primary btn-block mb-2">
                                        <i class="fas fa-list"></i> Manage ESP32 Devices
                                    </a>
                                    <a href="{% url 'admin_ui:network_session_list' %}" class="btn btn-outline-info btn-block mb-2">
                                        <i class="fas fa-history"></i> View Session History
                                    </a>
                                    <a href="{% url 'admin_ui:enhanced_dashboard' %}" class="btn btn-outline-success btn-block">
                                        <i class="fas fa-chart-bar"></i> View Dashboard
                                    </a>
                                </div>
                            </div>

                            <!-- How It Works -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title">🔍 How It Works</h5>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0">
                                        <li><strong>Select Course:</strong> Choose from your assigned courses</li>
                                        <li><strong>Set Time:</strong> Specify when the session starts</li>
                                        <li><strong>ESP32 Configures:</strong> Device gets dynamic WiFi name and settings</li>
                                        <li><strong>Students Connect:</strong> They see WiFi like "Attendance_CS101_John_14:30"</li>
                                        <li><strong>Mark Attendance:</strong> Students enter matric number on captive portal</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh device status -->
<script>
    // Refresh device status every 30 seconds
    setInterval(function() {
        location.reload();
    }, 30000);
</script>
{% endblock %}
