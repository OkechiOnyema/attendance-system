{% extends 'admin_ui/base.html' %}
{% load static %}

{% block title %}Start Attendance Session{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">ğŸš€ Start New Attendance Session</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Course Selection -->
                        <div class="mb-3">
                            <label for="course" class="form-label">ğŸ“š Select Course *</label>
                            <select class="form-select" id="course" name="course" required>
                                <option value="">Choose a course...</option>
                                {% for assignment in assigned_courses %}
                                    <option value="{{ assignment.course.id }}" 
                                            data-session="{{ assignment.session }}"
                                            data-semester="{{ assignment.semester }}">
                                        {{ assignment.course.code }} - {{ assignment.course.title }}
                                        ({{ assignment.session }}, {{ assignment.semester }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the course for this attendance session</div>
                        </div>

                        <!-- Session and Semester (Auto-filled) -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="session" class="form-label">ğŸ“… Academic Session</label>
                                    <input type="text" class="form-control" id="session" name="session" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="semester" class="form-label">ğŸ“š Semester</label>
                                    <input type="text" class="form-control" id="semester" name="semester" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Date Selection -->
                        <div class="mb-3">
                            <label for="date" class="form-label">ğŸ“… Session Date *</label>
                            <input type="date" class="form-control" id="date" name="date" required 
                                   value="{{ today_date|date:'Y-m-d' }}" max="{{ today_date|date:'Y-m-d' }}">
                            <div class="form-text">Select the date for this attendance session</div>
                        </div>

                        <!-- Time Selection -->
                        <div class="mb-3">
                            <label for="time" class="form-label">ğŸ• Session Time *</label>
                            <div class="input-group">
                                <input type="time" class="form-control" id="time" name="time" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="setCurrentTime()">
                                    ğŸ• Now
                                </button>
                            </div>
                            <div class="form-text">Select the time for this attendance session or click "Now" for current time</div>
                        </div>

                        <!-- Session Type -->
                        <div class="mb-3">
                            <label class="form-label">ğŸ¯ Session Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="session_type" 
                                       id="manual" value="manual" checked>
                                <label class="form-check-label" for="manual">
                                    ğŸ“ Manual Attendance Marking
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="session_type" 
                                       id="esp32" value="esp32">
                                <label class="form-check-label" for="esp32">
                                    ğŸ›°ï¸ ESP32 Presence Verification (Coming Soon)
                                </label>
                            </div>
                        </div>

                        <!-- Course Info Display -->
                        <div id="courseInfo" class="alert alert-info d-none">
                            <h6>ğŸ“Š Course Information</h6>
                            <div id="courseDetails"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'admin_ui:lecturer_attendance_dashboard' %}" 
                               class="btn btn-outline-secondary me-md-2">
                                â† Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary">
                                ğŸš€ Start Attendance Session
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ’¡ How it works</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li>Select the course you want to take attendance for</li>
                        <li>Choose the date for the session</li>
                        <li>Click "Start Attendance Session" to create the session</li>
                        <li>You'll be redirected to mark attendance for enrolled students</li>
                        <li>Mark each student as present or absent</li>
                        <li>Save the attendance records</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.getElementById('course');
    const sessionInput = document.getElementById('session');
    const semesterInput = document.getElementById('semester');
    const courseInfo = document.getElementById('courseInfo');
    const courseDetails = document.getElementById('courseDetails');
    
    // Set current time by default
    setCurrentTime();

    courseSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const session = selectedOption.dataset.session;
            const semester = selectedOption.dataset.semester;
            
            sessionInput.value = session;
            semesterInput.value = semester;
            
            // Show course info
            courseInfo.classList.remove('d-none');
            courseDetails.innerHTML = `
                <strong>Course:</strong> ${selectedOption.text}<br>
                <strong>Session:</strong> ${session}<br>
                <strong>Semester:</strong> ${semester}
            `;
        } else {
            sessionInput.value = '';
            semesterInput.value = '';
            courseInfo.classList.add('d-none');
        }
    });

    // Set today's date as max date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').setAttribute('max', today);
});

function setCurrentTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const currentTime = `${hours}:${minutes}`;
    document.getElementById('time').value = currentTime;
}
</script>
{% endblock %}
