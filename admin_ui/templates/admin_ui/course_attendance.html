{% extends 'admin_ui/base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>üìã Attendance for {{ assigned_course.course.title }} ({{ assigned_course.course.code }})</h2>
    <p><strong>Session:</strong> {{ assigned_course.session }} | <strong>Semester:</strong> {{ assigned_course.semester }}</p>

    <!-- Success/Error Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Take Attendance Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>üìù Take Attendance for Today ({{ today|date:"F j, Y" }})</h4>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="take_attendance" value="1">
                
                <!-- Time Selection -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="time" class="form-label">üïê Session Time</label>
                        <div class="input-group">
                            <input type="time" class="form-control" id="time" name="time" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="setCurrentTime()">
                                üïê Now
                            </button>
                        </div>
                        <div class="form-text">Select the time for this attendance session or click "Now" for current time</div>
                    </div>
                </div>

                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Matric No</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Network Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.matric_no }}</td>
                            <td>{{ student.name }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.matric_no }}" 
                                           id="present_{{ student.matric_no }}" 
                                           value="present"
                                           {% for key, value in existing_attendance.items %}
                                               {% if key == student.matric_no and value.status == 'present' %}checked{% endif %}
                                           {% endfor %}
                                           required>
                                    <label class="btn btn-outline-success" for="present_{{ student.matric_no }}">
                                        ‚úÖ Present
                                    </label>
                                    
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="status_{{ student.matric_no }}" 
                                           id="absent_{{ student.matric_no }}" 
                                           value="absent"
                                           {% for key, value in existing_attendance.items %}
                                               {% if key == student.matric_no and value.status == 'absent' %}checked{% endif %}
                                           {% endfor %}
                                           required>
                                    <label class="btn btn-outline-danger" for="absent_{{ student.matric_no }}">
                                        ‚ùå Absent
                                    </label>
                                </div>
                            </td>
                            <td>
                                {% for key, value in network_status.items %}
                                    {% if key == student.matric_no %}
                                        {% if value %}
                                            <span class="badge bg-success">üü¢ Connected</span>
                                        {% else %}
                                            <span class="badge bg-warning">üü° Not Connected</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted">Total Students: {{ students|length }}</span>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg">
                        üìä Submit Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Records Table -->
    <div class="card">
        <div class="card-header">
            <h4>üìã Attendance Records</h4>
        </div>
        <div class="card-body">
            {% if attendance_records %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="attendanceRecordsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Date & Time</th>
                                <th>Student</th>
                                <th>Status</th>
                                <th>Network Verified</th>
                                <th>ESP32 Device</th>
                                <th>Marked By</th>
                                <th>Marked At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records %}
                            <tr>
                                <td>
                                    <strong>{{ record.attendance_session.date|date:"M j, Y" }}</strong><br>
                                    <small class="text-muted">{{ record.attendance_session.time|time:"g:i A" }}</small>
                                </td>
                                <td>
                                    <strong>{{ record.student.name }}</strong><br>
                                    <small class="text-muted">{{ record.student.matric_no }}</small>
                                </td>
                                <td>
                                    {% if record.status == 'present' %}
                                        <span class="badge bg-success">‚úÖ Present</span>
                                    {% else %}
                                        <span class="badge bg-danger">‚ùå Absent</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.network_verified %}
                                        <span class="badge bg-success">üü¢ Yes</span>
                                    {% else %}
                                        <span class="badge bg-warning">üü° No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.esp32_device %}
                                        <span class="badge bg-info">{{ record.esp32_device }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.marked_by %}
                                        {{ record.marked_by.username }}
                                    {% else %}
                                        <span class="text-muted">System</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if record.marked_at %}
                                            {{ record.marked_at|date:"g:i A" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Export Button -->
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="exportAttendance()">
                        üì• Export to CSV
                    </button>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <p class="text-muted">No attendance records found for this course.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function exportAttendance() {
    // Create CSV content
    let csv = 'Date,Session Time,Student Name,Matric No,Status,Network Verified,ESP32 Device,Marked By,Marked At\n';
    
    const rows = document.querySelectorAll('table tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
            const date = cells[0].querySelector('strong')?.textContent.trim() || '';
            const sessionTime = cells[0].querySelector('small')?.textContent.trim() || '';
            const studentName = cells[1].querySelector('strong')?.textContent.trim() || '';
            const matricNo = cells[1].querySelector('small')?.textContent.trim() || '';
            const status = cells[2].textContent.trim();
            const networkVerified = cells[3].textContent.trim();
            const esp32Device = cells[4].textContent.trim();
            const markedBy = cells[5].textContent.trim();
            const markedAt = cells[6].textContent.trim();
            
            csv += `"${date}","${sessionTime}","${studentName}","${matricNo}","${status}","${networkVerified}","${esp32Device}","${markedBy}","${markedAt}"\n`;
        }
    });
    
    // Download CSV file
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'attendance_records.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Check for success messages and reset form if needed
document.addEventListener('DOMContentLoaded', function() {
    // Set current time when page loads
    setCurrentTime();
});

// Form submission handler
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'üìä Submitting...';
    }
    
    // Collect form data
    const formData = new FormData(this);
    formData.append('take_attendance', '1');
    
    // Submit via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showMessage(data.message, 'success');
            
            // Update attendance records table
            updateAttendanceTable(data.attendance_records);
            
            // Reset form
            this.reset();
            setCurrentTime();
            
            // Reset radio buttons
            const radioButtons = this.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
            });
        } else {
            showMessage(data.message || 'Error occurred', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while submitting attendance', 'danger');
    })
    .finally(() => {
        // Re-enable submit button
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üìä Submit Attendance';
        }
    });
});

function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.alert');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert message at the top of the form
    const form = document.querySelector('form');
    form.parentNode.insertBefore(messageDiv, form);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

function updateAttendanceTable(records) {
    const tbody = document.querySelector('#attendanceRecordsTable tbody');
    if (!tbody) return;
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add new rows
    records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${record.date}</strong><br>
                <small class="text-muted">${record.time}</small>
            </td>
            <td>
                <strong>${record.student_name}</strong><br>
                <small class="text-muted">${record.matric_no}</small>
            </td>
            <td>
                ${record.status === 'present' ? 
                    '<span class="badge bg-success">‚úÖ Present</span>' : 
                    '<span class="badge bg-danger">‚ùå Absent</span>'}
            </td>
            <td>
                ${record.network_verified ? 
                    '<span class="badge bg-success">üü¢ Yes</span>' : 
                    '<span class="badge bg-warning">üü° No</span>'}
            </td>
            <td>
                ${record.esp32_device !== '-' ? 
                    `<span class="badge bg-info">${record.esp32_device}</span>` : 
                    '<span class="text-muted">-</span>'}
            </td>
            <td>
                ${record.marked_by !== 'System' ? record.marked_by : '<span class="text-muted">System</span>'}
            </td>
            <td>
                <small class="text-muted">${record.marked_at}</small>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update total count
    const totalElement = document.querySelector('.text-muted');
    if (totalElement && totalElement.textContent.includes('Total Students:')) {
        totalElement.textContent = `Total Students: ${records.length}`;
    }
}

function setCurrentTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('time').value = `${hours}:${minutes}`;
}
</script>
{% endblock %}
